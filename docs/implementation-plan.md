# zsh SKK プラグイン実装方針

## 目的とスコープ
- zinit でインストールできる `zskk` プラグインを提供し、zsh のコマンドライン上で SKK と同等の日本語入力体験を実現する。
- 既存の zsh 環境・設定を破壊しない最小限の副作用で動作させる。
- 依存は zsh 組み込みモジュール（`zsh/zle`, `zsh/parameter`, `zsh/regex` など）に限定し、追加バイナリに頼らない。

## 全体アーキテクチャ
- ZLE (Zsh Line Editor) のカスタムウィジェット群で SKK の振る舞いを再現する。
- ローマ字入力 → 仮名変換 → 辞書検索 → 候補提示・確定 のパイプラインをプラグイン内のステートマシンで管理する。
- SKK 形式の辞書ファイル（システム辞書 + 個人辞書）を読み込み、メモリ上で効率的に検索できるデータ構造に整形する。
- 候補表示は `zle -M` を活用したミニバッファ表示とし、確定時にはバッファ書き換えを行う。

## 機能要件
- ローマ字かな変換（ひらがな／カタカナ）と ASCII 直接入力のモード切り替え。
- 変換候補の循環 (`C-j` / `C-k` など) と候補一覧の即時確定。
- 未知語登録・再学習（個人辞書への追記）。
- 全角・半角記号、送り仮名、長音といった SKK 特有のキー操作対応。
- 起動時設定フック（辞書パス、初期モード、キーバインド）をユーザーが調整できる。

## 非機能要件
- 初回ロード時以外はレスポンス 50ms 以下で候補提示。
- 辞書ファイルが存在しない場合はデフォルトで `SKK-JISYO.L` を自動ダウンロードするオプションを提供。
- macOS / Linux (UTF-8) で動作検証。Windows Subsystem for Linux はベストエフォート対応。

## 技術方針
### 辞書管理
- 標準 SKK 辞書フォーマットをそのまま扱い、ロード時に `awk` 等へ依存しないパーサーを zsh スクリプトで実装。
- 起動時にシステム辞書を読み込みハッシュマップ（キー: 語幹, 値: 候補列）に展開。必要に応じて遅延読み込みフラグを設け、大規模辞書ではファイルシーク検索も検討。
- 個人辞書は `~/.zskk-jisyo` をデフォルトとし、登録タイミングで追記。衝突防止のためファイルロック（`zsystem flock`）を利用。

### ステートマシン
- モード: `direct`, `hiragana`, `katakana`, `jisx0201`, `lookup` を定義。
- 入力バッファ、送り仮名バッファ、候補リスト、現在候補インデックスなどを `typeset -g` で保持。
- 仮名変換はローマ字テーブル（`declare -A`）を利用し逐次解析。未確定文字列はプレエディットとして表示。

### ZLE 統合
- `zle -N zskk-self-insert` 等のカスタムウィジェットで `self-insert` を置き換える。
- `bindkey -M viins` / `emacs` キーマップ両対応のため、インストール時に現在のキーマップへ動的に紐付け。
- 確定・キャンセル・モード切替キー（例: `C-j`, `C-l`, `C-\`）を提供し、ユーザーが `zstyle` で上書き可能にする。

### 候補表示 UI
- 候補は `zle -M` で右下に表示し、直近の数件を `1.` `2.` と番号付きで出す。
- 候補数が多い場合、ページング (`;` / `:`) で移動。インタラクションは同期的に処理し、ZLE ループをブロックしない。
- 候補選択確定時は `zle replace-region` を使用し、直前の未確定文字列と置換。

### 設定インターフェース
- `zstyle ':zskk:*' dict-path` 等の名前空間で設定を受け付ける。
- モード切替キーや候補キーも `zstyle` または `ZSKK_HOTKEY_*` 環境変数で上書きできるようにする。
- 初期化時に `autoload -Uz zskk` を行い、必要モジュールを `zmodload`。

### zinit 連携
- レポジトリアウトライン: `zskk.plugin.zsh`（本体）、`functions/`（補助スクリプト）、`jisyo/`（サンプル辞書）。
- 推奨インストール文: `zinit light user/zskk`。辞書ダウンロードが必要な場合は `atclone` フックで `curl` 実行。
- `atload` フックで `zskk-init` を呼び、キーバインド初期化。

## 実装ステップ
1. **スケルトン整備**: プラグインエントリ `zskk.plugin.zsh` と初期化関数 `zskk-init` を作成。モジュールロードと設定読み込みを記述。
2. **辞書ローダー**: SKK 辞書のパース関数、ハッシュ化、個人辞書ロード／書き込み API を実装。最小限のテストデータで検証。
3. **ローマ字かな変換**: 変換テーブルと未確定バッファ処理を実装し、ひらがな／カタカナ／ASCII モードを切り替え可能にする。
4. **変換エンジン**: 語幹 + 送り仮名で辞書検索し、候補リスト管理と学習（個人辞書への再配置）を実装。
5. **ZLE ウィジェット**: `self-insert`, `accept-line`, `backspace`, `mode-toggle` など主要キーを差し替え、プレエディット表示と確定処理を接続。
6. **候補表示 UI**: `zle -M` メッセージ更新、候補ページング、番号選択 (`1`-`9`) を実装。
7. **エッジケース対応**: undo/redo, マルチバイト文字、他プラグインとのキー競合を確認。`zstyle` 設定適用テスト。
8. **ドキュメント整備**: README, 使用例、辞書セットアップ方法、トラブルシューティングを追加。
9. **テスト計画**: `zunit` によるユニットテスト (辞書パース、変換ロジック) と手動操作のチェックリストを作成。

## リスクと対策
- **辞書サイズによる起動遅延**: 遅延読み込みとキャッシュファイル (`~/.cache/zskk.dict`) を検討。
- **ZLE フック競合**: oh-my-zsh 等との衝突を避けるため、既存バインドを保存し、無効化時に復元する。
- **個人辞書破損**: 書き込み前にバックアップを自動生成し、失敗時はロールバック。
- **多バイト処理の不具合**: `setopt multibyte` を強制せず、未設定環境では警告を出す。

## マイルストーン
- M1 (週1): プラグインスケルトン + ローマ字かな変換まで。
- M2 (週2): 辞書検索・候補表示を完了し、基本的な SKK 操作が可能。
- M3 (週3): 個人辞書、設定項目、zinit 配布準備。
- M4 (週4): ドキュメント、テスト、リリースタグ作成。

## 将来拡張案
- 動的辞書更新 (SKK サーバー互換プロトコル)。
- 候補ポップアップのための TUI (fzf 連携)。
- 変換学習のためのスコアリングアルゴリズム導入。
- コマンドライン以外のアプリケーションへのブリッジ (tmux pane 全体への適用)。
